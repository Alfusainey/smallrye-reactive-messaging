<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SmallRye Reactive Messaging</title>
    <meta name="generator" content="Antora 2.3.0-beta.1">
    <link rel="stylesheet" href="../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../..">SmallRye Reactive Messaging</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Project</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/smallrye/smallrye-reactive-messaging">Source Code</a>
            <a class="navbar-item" href="https://github.com/smallrye/smallrye-reactive-messaging/issues">Issue Tracker</a>
          </div>
        </div>
        <a class="navbar-item" href="https://smallrye.io/" alt=>A SmallRye.io Project</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="smallrye-reactive-messaging" data-version="2">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">SmallRye Reactive Messaging</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../getting-started.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../concepts.html">Concepts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../concepts.html#messages">Messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../concepts.html#channels">Channels</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../concepts.html#connectors">Connectors</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../model/model.html">Development Model</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#overview">Incoming and Outgoing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#messages">Creating Messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#generating-messages">Generating messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#generating-payloads">Generating payloads</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#consuming-messages">Consuming messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#consuming-payloads">Consuming payloads</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#processing-messages">Processing messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#processing-payloads">Processing payloads</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#processing-streams">Processing streams</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="acknowledgement.html">Acknowledgement</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../advanced/broadcast.html">Broadcasting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../advanced/merge.html">Merging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../advanced/incomings.html">Multiple @Incoming</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../signatures/signatures.html">Method signatures</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../connectors/connectors.html">Connectors</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../kafka/kafka.html">Apache Kafka</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../kafka/kafka.html#kafka-installation">Using the connector</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../kafka/kafka.html#kafka-inbound">Receiving Kafka Records</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../kafka/kafka.html#kafka-outbound">Writing Kafka Records</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../amqp/amqp.html">AMQP</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../amqp/amqp.html#amqp-installation">Using the connector</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../amqp/amqp.html#amqp-inbound">Receiving AMQP Messaging</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../amqp/amqp.html#amqp-outbound">Sending AMQP Messages</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../amqp/amqp.html#amqp-customization">Configuring the client</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../testing/testing.html">Testing applications</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<!-- This is the default navigation panel in the bottom left corner. We aren't using it, but let's keep it commented out
    should we change our minds about it -->
<!--
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">SmallRye Reactive Messaging</span>
    <span class="version">2</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">SmallRye Reactive Messaging</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">2</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
-->
    </div>
  </aside>
</div>
<main>
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">SmallRye Reactive Messaging</a></li>
    <li><a href="../model/model.html">Development Model</a></li>
    <li><a href="acknowledgement.html">Acknowledgement</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/clement/Projects/microprofile/smallrye-reactive-messaging//documentation/target/antora/modules/ROOT/pages/acknowledgement/acknowledgement.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<div class="sect1">
<h2 id="_acknowledgement"><a class="anchor" href="#_acknowledgement"></a>Acknowledgement</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Acknowledgement is an important concept in messaging.
A message is acknowledged when its processing or reception has been successful.
It allows the broker to move to the next message.</p>
</div>
<div class="paragraph">
<p>How acknowledgement is used and the exact effect in term of retry and resilience depends on the broker.
For example, for Kafka it would commit the offset.
For AMQP it would inform the broker that the message has been <em>accepted</em>.</p>
</div>
<div class="paragraph">
<p>Reactive Messaging supports acknowledgement.
Default acknowledgement depends on the method signature.
In addition, the acknolwedgement policy can be configured using the <code>@Acknowledgement</code> annotation.</p>
</div>
<div class="sect2">
<h3 id="_chain_of_acknowledgement"><a class="anchor" href="#_chain_of_acknowledgement"></a>Chain of acknowledgement</h3>
<div class="paragraph">
<p>If we reuse this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Incoming("source")
public Multi&lt;String&gt; generate() {
    return Multi.createFrom().items("Hello", "from", "reactive", "messaging");
}

@Incoming("source")
@Outgoing("sink")
public String process(String in) {
    return in.toUpperCase();
}

@Outgoing("sink")
public void consume(String processed) {
    System.out.println(processed);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The framework automatically acknowledge the message received from the <code>sink</code> channel when the <code>consume</code> method returns.
As a consequence, the message received by the <code>process</code> method is acknowledged, and so on.
In other words, a chain of acknowledgement is formed.</p>
</div>
<div class="paragraph">
<p>When using connectors to receive and consume messages, the outbound connector acknowledges the messages when they are dispatched successfully to the broker.
The acknowledgement chain would, as a result, acknowledges the inbound connector which would be able to send an acknowledgement to the broker.</p>
</div>
<div class="paragraph">
<p>This chain of acknowledgement is automatically implemented when processing payloads.</p>
</div>
</div>
<div class="sect2">
<h3 id="_acknowledgement_when_using_messages"><a class="anchor" href="#_acknowledgement_when_using_messages"></a>Acknowledgement when using Messages</h3>
<div class="paragraph">
<p>When using <code>Messages</code>, the acknowledgement is controlled by the user, and so the chain is not formed automatically.
It gives you more flexibility about when and how the the incoming message are acknowledged.</p>
</div>
<div class="paragraph">
<p>If you create a <code>Message</code> using the <code>with</code> method, is copy the acknowledgement function from the incoming message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Incoming("in")
@Outgoing("out")
public Message&lt;Integer&gt; process(Message&lt;Integer&gt; in) {
    // The acknowledgement is forwarded, when the consumer
    // acknowledges the message, `in` will be acknowledged
    return in.withPayload(in.getPayload() + 1);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To have more control over the acknowledgement, you can create a brand new <code>Message</code> and pass the acknowledgement function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Message&lt;String&gt; message = Message.of("hello", () -&gt; {
    // called when the consumer acknowledges the message

    // return a CompletionStage completed when the
    // acknowledgment of the created message is
    // completed.
    // For immediate ack use:
    return CompletableFuture.completedFuture(null);

});</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, you may need to create the acknowledgement chain, to acknowledge the incoming message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Incoming("in")
@Outgoing("out")
public Message&lt;Integer&gt; processAndProduceNewMessage(Message&lt;Integer&gt; in) {
    // The acknowledgement is forwarded, when the consumer
    // acknowledges the message, `in` will be acknowledged
    return Message.of(in.getPayload() + 1,
        () -&gt; {
            // Called when the consumer acknowledges the message
            // ...
            // Don't forget to acknowledge the incoming message:
            return in.ack();
        });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To trigger the acknowledgement of the incoming message, use the <code>ack()</code> method.
It returns a <code>CompletionStage</code>, completed when the acknowledgement has been done.</p>
</div>
</div>
<div class="sect2">
<h3 id="_acknowledgement_when_using_streams"><a class="anchor" href="#_acknowledgement_when_using_streams"></a>Acknowledgement when using streams</h3>
<div class="paragraph">
<p>When transforming streams of <code>Message</code>, the acknowledgement is delegated to the user.
It means that it&#8217;s up to the user to acknowledged the incoming messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Incoming("in")
@Outgoing("out")
public Publisher&lt;Message&lt;String&gt;&gt; transform(Multi&lt;Message&lt;String&gt;&gt; stream) {
    return stream
        .map(message -&gt;
            message.withPayload(message.getPayload().toUpperCase())
        );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the previous example, we only generate a single message per incoming message, so we can use the <code>with</code> method.
It become more complicated when grouping incoming messages or when each incoming message produce multiple messages.</p>
</div>
<div class="paragraph">
<p>In the case of a stream of payloads, the default strategy acknowledges the incoming messages before being processed by the method (regardless the outcome).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Incoming("in")
@Outgoing("out")
public Publisher&lt;String&gt; transformPayload(Multi&lt;String&gt; stream) {
    return stream
        // The incoming messages are already acknowledged
        .map(String::toUpperCase);
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_controlling_acknowledgement"><a class="anchor" href="#_controlling_acknowledgement"></a>Controlling acknowledgement</h3>
<div class="paragraph">
<p>The <code>org.eclipse.microprofile.reactive.messaging.Acknowledgment</code> annotation lets you customize the default strategy that have been covered in the previous sections.
The <code>@Acknowledgement</code> annotation takes a <em>strategy</em> as parameter.
Reactive Messaging proposed 4 strategies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>POST_PROCESSING</code> - the acknowledgement of the incoming message is executed once the produced message is acknowledged.</p>
</li>
<li>
<p><code>PRE_PROCESSING</code> - the acknowledgement of the incoming message is executed before the message is processed by the method.</p>
</li>
<li>
<p><code>MANUAL</code> - the acknowledgement is doe by the user.</p>
</li>
<li>
<p><code>NONE</code> - No acknowledgement is performed, neither manually or automatically.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is recommend to use <code>POST_PROCESSING</code> as it guarantees that the full processing has completed before acknowledging the incoming message.
However, sometimes it&#8217;s not possible, and this strategy is not available if you manipulates streams of <code>Messages</code> or payloads.</p>
</div>
<div class="paragraph">
<p>The <code>PRE_PROCESSING</code> strategy can be useful to voluntarily acknowledge a message early in the process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Incoming("in")
@Outgoing("out")
@Acknowledgment(Acknowledgment.Strategy.PRE_PROCESSING)
public String process(String input) {
    // The message wrapping the payload is already acknowledged
    // The default would have waited the produced message to be
    // acknowledged
    return input.toUpperCase();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It cuts the acknowledgement chain, meaning that the rest of the processing is not linked to the incoming message anymore.
This strategy is the default strategy when manipulating streams of payloads.</p>
</div>
<div class="paragraph">
<p>Refer to the <a href="../signatures/signatures.html" class="page">signature list</a> to determine which strategies are available for a specific method signature and what&#8217;s the default strategy.</p>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <p>SmallRye Reactive Messaging is licensed until the terms of the Apache Software License 2.0</p>
  <p>Access the source code from the <a href="https://github.com/smallrye/smallrye-reactive-messaging">GitHub repository</a>.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
